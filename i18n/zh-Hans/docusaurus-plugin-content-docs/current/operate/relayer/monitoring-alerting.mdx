# 监控和告警

中继器在由参数 `--metrics` 指定的端口号上公开指标。默认端口为 `9090`，但可以选择任何有效的端口。

我们建议使用 Prometheus 来抓取这些指标，并使用 Grafana 来可视化它们，使用[此仪表板 JSON 模板](https://github.com/hyperlane-xyz/hyperlane-monorepo/blob/2f7f714c5b698fedcead9825f52da6ef95f96be1/tools/grafana/easy-relayer-dashboard-template.json)，如下所示。这个仪表板的优点是它可以同时显示多个验证器。截图显示了按链或按 kubernetes pod 分组的指标。

![中继器 Grafana 仪表板模板](/img/dashboard-template-relayer.png)

:::info

如果作为 Docker 镜像运行，请确保端口转发指标端点端口。例如，要在本地端口 80 上转发端口 9090，请在 `docker run` 命令中添加以下标志：`-p 9090:80`

:::

## 指标

仪表板模板包含以下指标。
| 指标                                                                                       | 描述                                                                                                                                                                                                                                                                                                                                                          |
|----------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `hyperlane_messages_processed_count`                                                         | 中继器处理的消息，按源链和目标链分类（"已处理消息"）。                                                                                                                                                                                                                                                                       |
| `hyperlane_submitter_queue_length{queue_name="prepare_queue"}`                               | 提交者的准备队列长度（"准备队列"）。每个目标链都有一个提交者在运行，所有待处理/可重试的消息都会进入准备队列，等待（重新）提交。此队列的增加可能意味着消息量超过了中继器的处理吞吐量，或者由于各种原因（RPC 不良、余额不足）导致提交失败。   |
| `hyperlane_submitter_queue_length{queue_name="submit_queue"}`                                | 提交者的提交队列长度（"提交队列"）。这些是已准备但尚未提交的消息。                                                                                                                                                                                                                                          |
| `hyperlane_submitter_queue_length{queue_name="confirm_queue"}`                               | 提交者的确认队列长度（"确认队列"）。这些是已提交但尚未确认（最终确定）的消息。                                                                                                                                                                                                                            |

其他相关指标包括：
| 指标                                                                         | 描述                                                                                                                                                                                                                                                                                                                         |
|--------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `hyperlane_request_count`                                                      | 记录成功或失败的 RPC 数量，使用以下标签：`chain`（链）、`status`（失败或成功）、`provider_node`（负责的基础 RPC URL）和 RPC `method`（方法）。适用于所有代理，但目前仅支持 EVM 链。                  
| `hyperlane_wallet_balance{agent="relayer"}`                                    | 中继器在每个链上的余额，以最小面额单位表示                                                                                                                                                                                                                                                     |
| `hyperlane_critical_error`                                                     | 链上关键错误的布尔标记，表示活跃度丢失。                                                                                                                                                                                                                                                     |
| `hyperlane_block_height`                                                       | 代理连接到的 RPC 节点的区块高度。如果此指标没有增加，RPC 可能不健康并需要更改。                                                                                                                                                                                           |
| `hyperlane_span_events_total{agent="relayer", event_level="error"}`            | 记录的错误总数。如果在过去一小时内此指标的导数超过 1，则至少需要低严重性告警。请注意，仪表板查询按 kubernetes pod 名称分组指标，因此如果您不在 kubernetes 环境中运行，可能需要调整此查询。                                                             |
| `hyperlane_span_events_total{agent="relayer", event_level="warn"}`             | 记录的警告总数。如果在过去一小时内此指标的导数超过 1，则至少需要低严重性告警。请注意，仪表板查询按 kubernetes pod 名称分组指标，因此如果您不在 kubernetes 环境中运行，可能需要调整此查询。                                                            |


## 告警
可以组合上述指标来创建最小化误报的告警。一些示例关键告警：

### 适用于所有代理：
- 任何链的 `hyperlane_block_height` 在过去 15 分钟内没有增加
- 过去 10 分钟内 `hyperlane_request_count{status="failure"}` 的比率 > `hyperlane_request_count{status=~"success|failure"}` 的 60%。大多数代理问题都是由于 RPC 不良造成的，这很可能会捕获到这些问题。

### 适用于中继器：
- 某个链的 `hyperlane_critical_error` 为 `1`，意味着中继器在该链上失去了活跃度。虽然其他链上的操作不受此影响，但这是一个高严重性告警 - 通常与受影响链的 RPC 不可靠有关。
- 使用 `hyperlane_submitter_queue_length{queue_name="prepare_queue"}`，在过去 30 分钟内，准备队列长度一直在增加，确认队列长度为零，且错误/警告计数差异一直在增加。这可能意味着中继器已耗尽余额无法支付 gas 费用，或者目标链 RPC url 工作不正常，或者只是所有新消息都无法处理
- `hyperlane_wallet_balance` 已降至某个阈值以下。例如，当前余额除以过去 24 小时的差值小于 2，意味着必须在两天内充值

如果收到告警，请始终检查日志以了解可能的问题所在。
