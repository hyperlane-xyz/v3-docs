import TerminologyPartial from "/docs/partials/deploy-hyperlane/_terminology.mdx";
import SetupKeysPartial from "/docs/partials/deploy-hyperlane/_setup-keys.mdx";
import DeployContractsPartial from "/docs/partials/deploy-hyperlane/_deploy-contracts.mdx";
import SendTestMessagesPartial from "/docs/partials/deploy-hyperlane/_send-test-messages.mdx";
import DeployWarpRoutePartial from "/docs/partials/deploy-hyperlane/_deploy-warp-route.mdx";

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# 使用本地代理部署Hyperlane

:::tip

这个指南适用于高级用户，他们可能最终打算在类似生产环境的环境中运行Hyperlane代理。它将介绍如何手动配置和运行代理的基础知识，但**不是生产设置指南**。

如果尚未这样做，初学者应该从[**deploying Hyperlane with Kurtosis agents**](../deploy-hyperlane.mdx)开始。

:::

<TerminologyPartial />

## 概览

这个指南分为六个步骤：

1. [<b>Set up keys</b>](#1-set-up-keys) ：您将使用这些密钥部署合约并运行验证人和中继器。
1. [<b>Deploy contracts</b>](#2-deploy-contracts) ：在本地链和与本地链能够发送和接收消息的每个远程链上部署合约。
1. [<b>Run a validator</b>](#3-run-a-validator) ：为您部署的互链安全模块提供所需的签名。
1. [<b>Run a relayer</b>](#4-run-a-relayer) ：在您部署合约的链之间发送和接收消息。
1. [<b>Send a test message</b>](#5-send-test-messages) ：确认您的中继能够在每对链之间传递消息。
1. [<b>Deploy a Warp Route</b>](#6-optional-deploy-a-warp-route) ：跨链发送令牌，而不仅仅是消息。

## 立即开始

## 1. 设置密钥

<SetupKeysPartial />

## 2. 部署合约

<DeployContractsPartial />

## 3. 运行验证人

验证者为从您的链发送到远程链的消息提供安全性。仅在使用[Multisig ISM](../protocol/ISM/multisig-ISM.mdx)时才需要它们。

### 设置目录

首先，将`CONFIG_FILES`环境变量设置为在[deploy contracts](#2-deploy-contracts)步骤中生成的代理配置文件的路径。例如：

```bash
export CONFIG_FILES=/full/path/to/configs/agent-config-{timestamp}.json
```

接下来，创建一个本地目录，用于让您的验证器将其签名写入其中。记住这个路径，因为在配置验证器时您将需要它。

:::danger
验证器签名路径将作为[validator announcement transaction](./implementation-guide.mdx#validator-announce)的一部分写入链上。**请注意不要泄露任何安全敏感或个人信息！**
:::

```sh
# 选择一个具体到您正在验证的链的信息性名称
export VALIDATOR_SIGNATURES_DIR=/tmp/hyperlane-validator-signatures-<your_chain_name>

# 创建目录
mkdir -p $VALIDATOR_SIGNATURES_DIR
```

:::warning

在Mac上通过Docker运行代理时，您将无法将任何内容挂载到 `/tmp`。为了解决这个问题，请创建一个本地的 `tmp` 目录进行挂载。

```sh
# 创建一个本地的 tmp 目录，该目录可以被 Docker 访问。
mkdir tmp

# 选择一个具有特定信息的名称，该名称与您正在验证的链相关。
export VALIDATOR_SIGNATURES_DIR=tmp/hyperlane-validator-signatures-<your_chain_name>

# 创建目录
mkdir -p $VALIDATOR_SIGNATURES_DIR
```

:::

### 配置

Validators可以配置许多参数。对于本指南，我们只关心其中的一小部分：

| 参数                       | 说明                                                                                                          |
| ------------------------- | ------------------------------------------------------------------------------------------------------------- |
| `--db`                    | 持久化数据写入磁盘的路径。                                                                                         |
| `--originChainName`       | 正在验证的链的名称(例如:`ethereum`)。                                                                              |
| `--checkpointSyncer.type` | 本指南中设置为 `localStorage`。                                                                                  |
| `--checkpointSyncer.path` | 写入验证程序签名的本地目录路径。与 `$VALIDATOR_SIGNATURES_DIR`相同。                                                  |
| `--validator.key`         | 验证器的十六进制私钥。                                                                                             |

:::info

确保验证器密钥对应于设置MultisigIsmConfig时提供的地址。否则，你在上一步中部署的Multisig ISM将无法验证从你的链发送的消息。

:::

要了解您可以更改的所有参数，请阅读[agent configuration reference](../operate/config-reference.mdx)。

<Tabs groupId="docker">
<TabItem value="docker" label="Using Docker">

****更新代理配置****

除非您正在Linux上运行Docker，否则您还需要更新您网络的代理配置。这是因为Docker在Mac、Windows或Windows Server上不支持[`host` network mode](https://docs.docker.com/network/drivers/host/)。

要做到这一点，请转到`$CONFIG_FILES`下的代理配置，将所有实例中的 "localhost" 或 "127.0.0.1" 替换为 `host.docker.internal`。例如：

```json
...
"localnet1": {
  ...
  "rpcUrls": [
    {
      // "http": "http://localhost:8545"
      // "http": "http://127.0.0.1:8545"
      "http": "http://host.docker.internal:8545"
    }
  ],
  ...
},
...
```

**挂载目录**

使用Docker运行会增加额外的复杂性，因为配置文件需要从Docker容器内部访问，并且验证器签名需要从容器外部访问，以便中继器能够读取。这样中继器就可以构建所需的元数据，以便消息能够成功地通过Multisig ISM进行验证。

为解决这个问题，您可以将文件系统中的目录挂载到容器中。在下面的参数中，我们：

1. 将 `$CONFIG_FILES` 环境变量设置为容器内的固定路径。
1. 将代理配置文件挂载到此固定路径，并将其设置为只读。
1. 将持久数据目录挂载到容器内的固定路径。
1. 将验证器签名目录挂载到容器内的固定路径。

```sh
...
-e CONFIG_FILES=/config/agent-config.json \
--mount type=bind,source=$CONFIG_FILES,target=/config/agent-config.json,readonly \
--mount type=bind,source="$(pwd)"/hyperlane_db_validator_<your_chain_name>,target=/hyperlane_db \
--mount type=bind,source="$(pwd)"/$VALIDATOR_SIGNATURES_DIR,target=/tmp/validator-signatures \
...
```

硬编码这些路径可以在运行验证器的不同源链的Docker实例之间去重配置。这样可以更轻松地在运行容器时传递正确的参数。请参阅下面的示例，其中唯一需要针对不同链进行不同配置的是链名称和验证器密钥。

```sh
...
./validator \
--db /hyperlane_db \
--originChainName <your_chain_name> \
--checkpointSyncer.type localStorage \
--checkpointSyncer.path /tmp/validator-signatures \
--validator.key <your_validator_key>
...
```

</TabItem>
<TabItem value="from-source" label="Building from source">

**克隆并设置**

首先，克隆Hyperlane monorepo：

```sh
git clone git@github.com:hyperlane-xyz/hyperlane-monorepo.git
```

然后按照`rust`目录中的[setup instructions](https://github.com/hyperlane-xyz/hyperlane-monorepo/blob/main/rust/README.md)进行操作。这将设置`rustup`，如果你使用的是Apple Silicon，需要安装 Rosetta 2。

```sh
# install rustup
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# (apple silicon only) install rosetta 2
softwareupdate --install-rosetta --agree-to-license
```

</TabItem>
</Tabs>

### 运行

<Tabs groupId="docker">
<TabItem value="docker" label="Using Docker">
现在您对配置验证器参数有了更多的了解，请拉取最新的Docker镜像：

```sh
docker pull gcr.io/abacus-labs-dev/hyperlane-agent:3adc0e9-20240319-152359
```

在运行之前，请确保所有需要挂载的目录都存在。这可能需要创建 `hyperlane_db_validator_<your_chain_name>`，如果它尚不存在的话。

```sh
mkdir -p hyperlane_db_validator_<your_chain_name>
```
最后，运行验证程序：

```sh
docker run \
  -it \
  -e CONFIG_FILES=/config/agent-config.json \
  --mount type=bind,source=$CONFIG_FILES,target=/config/agent-config.json,readonly \
  --mount type=bind,source="$(pwd)"/hyperlane_db_validator_<your_chain_name>,target=/hyperlane_db \
  --mount type=bind,source="$(pwd)"/$VALIDATOR_SIGNATURES_DIR,target=/tmp/validator-signatures \
  gcr.io/abacus-labs-dev/hyperlane-agent:3adc0e9-20240319-152359 \
  ./validator \
  --db /hyperlane_db \
  --originChainName <your_chain_name> \
  --checkpointSyncer.type localStorage \
  --checkpointSyncer.path /tmp/validator-signatures \
  --validator.key <your_validator_key>
```

</TabItem>

<TabItem value="from-source" label="Building from source">

完成设置后，您现在应该能够使用`cargo`运行验证器：

```sh
cargo run --release --bin validator -- \
    --db ./hyperlane_db_validator_<your_chain_name> \
    --originChainName <your_chain_name> \
    --checkpointSyncer.type localStorage \
    --checkpointSyncer.path $VALIDATOR_SIGNATURES_DIR \
    --validator.key <your_validator_key>
```

:::note （可选）：直接运行二进制文件

你也可以构建代理程序：

```sh
cargo build --release bin validator
```

然后直接运行二进制文件：

```sh
./target/release/validator \
    --db ./hyperlane_db_validator_<your_chain_name> \
    --originChainName <your_chain_name> \
    --checkpointSyncer.type localStorage \
    --checkpointSyncer.path $VALIDATOR_SIGNATURES_DIR \
    --validator.key <your_validator_key>
```

:::

</TabItem>
</Tabs>

欲了解更多信息，请查阅[Validators guide](../operate/validators/run-validators.mdx)。

## 4. 运行中继器

Relayers负责传递在本地链和远程链之间发送的跨链消息。

如果还没有，请确保已将 `CONFIG_FILES` 环境变量设置为在[deploy contracts](#2-deploy-contracts)步骤中生成的代理配置文件的路径。

```bash
export CONFIG_FILES=/full/path/to/configs/agent-config-{timestamp}.json
```

### 配置

这个指南涉及到配置验证器的许多参数。对于这个指南，我们只关注其中的一小部分：

| 参数                             | 说明                                                                                     |
| ------------------------------- | ---------------------------------------------------------------------------------------- |
| `--db`                          | 将持久数据写入磁盘的路径。                                                                    |
| `--relayChains`                 | 用逗号分隔要中继的链的名称。如`ethereum,polygon,avalanche`。                                   |
| `--allowLocalCheckpointSyncers` | 允许中继器在本地文件系统上查找验证器签名。                                                       |
| `--defaultSigner.key`           | 用于为所有链签署事务的十六进制私钥。                                                            |
| `--metrics-port`                | 可选的。公开prometheus监控指标的端口默认为`9090`。                                              |

:::tip
您的中继链集应包括原始链和目标链。
:::

要了解您可以更改的所有参数，请阅读[agent configuration reference](../operate/config-reference.mdx)。

<Tabs groupId="docker">
<TabItem value="docker" label="Using Docker">

**挂载目录**
对于中继器（relayer），我们向Docker提供的参数几乎与验证器相同。

1. 将`$CONFIG_FILES`环境变量设置为容器内的固定路径。
1. 将代理配置文件挂载到此固定路径，并将其设置为**只读**。
1. 将持久化数据目录挂载到容器内的固定路径。
1. 将验证器签名目录挂载到容器内的固定路径，并将其设置为**只读**。

```sh
...
-e CONFIG_FILES=/config/agent-config.json \
--mount type=bind,source=$CONFIG_FILES,target=/config/agent-config.json,readonly \
--mount type=bind,source="$(pwd)"/hyperlane_db_relayer,target=/hyperlane_db \
--mount type=bind,source="$(pwd)"/$VALIDATOR_SIGNATURES_DIR,target=/tmp/validator-signatures,readonly \
...
```

硬编码这些路径可以消除在运行中维护不同链集的中继器的Docker实例之间的配置重复。这样可以在运行容器时更容易传递正确的参数。请参阅下面的示例，其中唯一需要针对不同链进行配置的项目是中继的链列表和中继器密钥。

</TabItem>
<TabItem value="from-source" label="Building from source">

**克隆并设置**

如果还没有这样做，请克隆Hyperlane monorepo并按照 `rust` 目录中的[setup instructions](https://github.com/hyperlane-xyz/hyperlane-monorepo/blob/main/rust/README.md)进行操作。

```sh
# clone hyperlane monorepo
git clone git@github.com:hyperlane-xyz/hyperlane-monorepo.git

# install rustup
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# (apple silicon only) install rosetta 2
softwareupdate --install-rosetta --agree-to-license
```

</TabItem>
</Tabs>

### 运行

<Tabs groupId="docker">
<TabItem value="docker" label="Using Docker">

如果您还没有拉取 Docker 镜像，请现在运行以下命令进行操作：

```sh
docker pull gcr.io/abacus-labs-dev/hyperlane-agent:3adc0e9-20240319-152359
```

在运行之前，请确保所有需要挂载的目录都存在。如果尚不存在的话，可能需要创建 `hyperlane_db_relayer` 目录。

```sh
mkdir -p hyperlane_db_validator_<your_chain_name>
```

最后，运行中继器：

```sh
docker run \
  -it \
  -e CONFIG_FILES=/config/agent-config.json \
  --mount type=bind,source=$CONFIG_FILES,target=/config/agent-config.json,readonly \
  --mount type=bind,source="$(pwd)"/hyperlane_db_relayer,target=/hyperlane_db \
  --mount type=bind,source="$(pwd)"/$VALIDATOR_SIGNATURES_DIR,target=/tmp/validator-signatures,readonly \
  gcr.io/abacus-labs-dev/hyperlane-agent:3adc0e9-20240319-152359 \
  ./relayer \
  --db /hyperlane_db \
  --relayChains <chain_1_name>,<chain_2_name> \
  --allowLocalCheckpointSyncers true \
  --defaultSigner.key <your_relayer_key> \
```

</TabItem>
<TabItem value="from-source" label="Building from source">

在按照设置说明进行操作后，您现在应该可以使用`cargo` 运行中继器了：

```sh
cargo run --release --bin relayer -- \
    --db ./hyperlane_db_relayer \
    --relayChains <chain_1_name>,<chain_2_name> \
    --allowLocalCheckpointSyncers true \
    --defaultSigner.key <your_relayer_key> \
    --metrics-port 9091
```

为了避免与验证器发生冲突，metrics端口被覆盖。

:::note （可选）：直接运行二进制文件

您也可以选择构建代理程序：

```sh
cargo build --release bin relayer
```

然后直接运行二进制文件：

```sh
./target/release/relayer \
    --db ./hyperlane_db_relayer \
    --relayChains <chain_1_name>,<chain_2_name> \
    --allowLocalCheckpointSyncers true \
    --defaultSigner.key <your_relayer_key> \
    --metrics-port 9091
```

:::

</TabItem>
</Tabs>

要获取更多信息，请查阅[Relayer guide](../operate/relayer/run-relayer.mdx)。

## 5. 发送测试信息

<SendTestMessagesPartial />

## 6. (可选) 部署一个Warp Route

<DeployWarpRoutePartial />
