import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

import MessagingIsmDiagram from '@site/src/diagrams/messaging-isms.md';

import SimpleMessagingDiagram from '@site/src/diagrams/messaging-simple.md';

# 接收消息

合约可以通过实现`handle`函数来接收链间消息。

<SimpleMessagingDiagram/>

## Handle

当收到消息时，该函数由`Mailbox`合约调用。

:::danger
为了确保只接受有效的链间消息，将[access control](#access-control)限制为邮箱地址是很重要的。
:::

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/interfaces/IMessageRecipient.sol#L5-L9
```

**参数**

- `origin`: 原始链的域
- `sender`: 发件人在原始链上的地址，以bytes32表示
- `messageBody`: 消息体内容的原始字节

:::info
发送地址左填充为 `bytes32`，以兼容不同寻址的虚拟机。为了方便使用，[`TypeCasts` library](../libraries/typecasts.mdx)中提供了以下实用程序。
```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/libs/TypeCasts.sol#L10-L13
```
:::

</TabItem>
<TabItem value="cw" label="CosmWasm">

🚧 即将到来! 🚧

</TabItem>
<TabItem value="sl" label="Sealevel">

🚧 即将到来! 🚧

</TabItem>
</Tabs>

### 访问控制

如果合约只接受链间消息的调用，`handle`函数应限制为邮箱地址。

为了方便使用， [`MailboxClient` library](../libraries/mailboxclient.mdx)中提供了以下实用程序。

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/client/MailboxClient.sol#L45-L51
```

</TabItem>
<TabItem value="cw" label="CosmWasm">

🚧 即将到来! 🚧

</TabItem>
<TabItem value="sl" label="Sealevel">

🚧 即将到来! 🚧

</TabItem>
</Tabs>

### 示例

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/test/TestRecipient.sol#L30-L38
```

</TabItem>
<TabItem value="cw" label="CosmWasm">

🚧 即将到来! 🚧

</TabItem>
<TabItem value="sl" label="Sealevel">

🚧 即将到来! 🚧

</TabItem>
</Tabs>

## 验证

当收到消息时，在调用消息收件人的`handle`之前，邮箱将使用[Interchain Security Module](../ISM/specify-your-ISM.mdx)验证安全性。

### Default Security

默认的ISM地址可以通过`defaultIsm`函数查询。

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/interfaces/IMailbox.sol#L53
```

</TabItem>
</Tabs>

### 模块化安全

为了利用Hyperlane的模块化安全性，消息接收者可以指定一个自定义的链间安全模块来**验证任何关于传入消息的内容**。当指定时，该邮箱将遵从此ISM。

<MessagingIsmDiagram/>

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/interfaces/IInterchainSecurityModule.sol#L38-L41
```

</TabItem>
<TabItem value="cw" label="CosmWasm">

🚧 即将到来! 🚧

</TabItem>
<TabItem value="sl" label="Sealevel">

🚧 即将到来! 🚧

</TabItem>
</Tabs>
