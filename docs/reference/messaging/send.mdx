import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

import { MultiLanguageExample } from "@site/src/components/InteractiveExample";

import SimpleMessagingDiagram from '@site/src/diagrams/messaging-simple.md';

# å‘é€æ¶ˆæ¯

åˆçº¦å¯ä»¥é€šè¿‡è°ƒç”¨Mailboxä¸Šçš„`dispatch`å‡½æ•°æ¥å‘é€é“¾é—´æ¶ˆæ¯ã€‚

<SimpleMessagingDiagram/>

<details>
<summary>`IMailbox` Interface</summary>

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/interfaces/IMailbox.sol
```

</TabItem>
</Tabs>
</details>

## Dispatch

è°ƒç”¨æ­¤å‡½æ•°å°†æ¶ˆæ¯åˆ†å‘åˆ°ç›®æ ‡åŸŸå’Œæ”¶ä»¶äººã€‚

:::warning
Hyperlaneåªèƒ½å‘å®ç°`handle`å‡½æ•°çš„æ™ºèƒ½åˆçº¦ä¼ é€’æ¶ˆæ¯ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [receive a message](./receive.mdx) æ–‡æ¡£ã€‚
:::

æ ¹æ®[post-`dispatch` hook configuration](##post-dispatch-hook-config)ï¼Œå¯èƒ½éœ€è¦æ”¯ä»˜ä¸€äº›è´¹ç”¨ã€‚è¯·å‚é˜…[`quoteDispatch`](#quote-dispatch) å°èŠ‚äº†è§£æ›´å¤šä¿¡æ¯ã€‚

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/interfaces/IMailbox.sol#L59-L63

```

:::info
ä¸ºäº†ä¸åœ°å€ä¸åŒçš„è™šæ‹Ÿæœºå…¼å®¹ï¼Œæ”¶ä»¶äººåœ°å€è¢«ä¿ç•™ä¸º`bytes32`ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œåœ¨[`TypeCasts` library](../libraries/typecasts.mdx) ä¸­æä¾›äº†ä»¥ä¸‹å®ç”¨ç¨‹åºã€‚

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/libs/TypeCasts.sol#L5-L8

```

:::

</TabItem>
<TabItem value="cw" label="CosmWasm">

ğŸš§ å³å°†åˆ°æ¥! ğŸš§

</TabItem>
<TabItem value="sl" label="Sealevel">

ğŸš§ å³å°†åˆ°æ¥! ğŸš§

</TabItem>
</Tabs>

### ç¤ºä¾‹

<MultiLanguageExample
  solidity={({
    mailbox,
    originChain,
    destinationDomain,
    destinationChain,
    paddedRecipient,
    body,
  }) => `\
// send message from ${originChain} to ${destinationChain} TestRecipient
IMailbox mailbox = IMailbox("${mailbox}");
bytes32 messageId = mailbox.dispatch{value: msg.value}(
  ${destinationDomain},
  "${paddedRecipient}",
  bytes(\"${body}\")
);`}
/>

## Quote Dispatch

è´¹ç”¨é€šå¸¸é…ç½®ä¸ºæ”¯ä»˜IGPä»˜æ¬¾å’Œåè®®è´¹ç”¨ã€‚è¿™åŒ…æ‹¬ç›®æ ‡é“¾ä¸Šçš„äº‹åŠ¡æäº¤ã€å®‰å…¨é…ç½®å’Œç»´æŠ¤ã€‚è¦æ¥æ”¶å¯¹åº”çš„`dispatch`è°ƒç”¨çš„æŠ¥ä»·ï¼Œä½ å¯ä»¥æŸ¥è¯¢`quoteDispatch`å‡½æ•°ã€‚

```mermaid
flowchart TB
    subgraph Origin Chain
      Sender
      M_O[(Mailbox)]
      Sender <-- "fee = quoteDispatch(...)" --> M_O
      Sender -- "dispatch(...){fee}" --> M_O
    end
```

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/Mailbox.sol#L149-L153
```

å¼•ç”¨çš„`fee`å¿…é¡»ä½œä¸ºå€¼ä¼ é€’ç»™`dispatch`è°ƒç”¨ï¼Œä»¥ç¡®ä¿å®ƒä¸ä¼šå›æ»šã€‚

</TabItem>
<TabItem value="cw" label="CosmWasm">

ğŸš§ å³å°†åˆ°æ¥! ğŸš§

</TabItem>
<TabItem value="sl" label="Sealevel">

ğŸš§ å³å°†åˆ°æ¥! ğŸš§

</TabItem>
</Tabs>

### ç¤ºä¾‹

<MultiLanguageExample
  solidity={({
    mailbox,
    originChain,
    destinationDomain,
    destinationChain,
    paddedRecipient,
    body,
  }) => `\
// quote sending message from ${originChain} to ${destinationChain} TestRecipient
IMailbox mailbox = IMailbox("${mailbox}");
uint32 destination = ${destinationDomain};
bytes32 recipient = "${paddedRecipient}";
bytes memory body = bytes("${body}");
uint256 fee = mailbox.quoteDispatch(destination, recipient, body);
mailbox.dispatch{value: fee}(destination, recipient, body);
`}
/>

:::danger
å¯¹`dispatch`çš„ä»˜æ¬¾ä¸è¶³å°†å›æ»šã€‚å¦‚æœä½ å°†é’©å­ç»„åˆåœ¨ä¸€èµ·ï¼Œè¶…é¢æ”¯ä»˜å¯èƒ½ä¸ä¼šè¢«é€€è¿˜ç»™æ¶ˆæ¯å‘é€è€…ã€‚
:::

## Post-Dispatch Hook é…ç½®

åœ¨é‚®ç®±ä¸Šé…ç½®äº†ä¸¤ä¸ªé’©å­ï¼š

- `required`: æ‰€æœ‰`dispatch`éƒ½ä¼šè°ƒç”¨ï¼Œè°ƒç”¨å€¼ä¸ºæ‰€éœ€è´¹ç”¨
- `default`: åœ¨`required`é’©å­ä¹‹åç”¨å‰©ä½™å€¼è°ƒç”¨(é™¤éè¢«è¦†ç›–)

```mermaid
flowchart LR
    subgraph Origin Chain
      Sender
      M_O[(Mailbox)]
      R_H[RequiredHook]
      D_H[DefaultHook]
      Sender -- "dispatch(...){value}" --> M_O

      M_O -. "fee = quoteDispatch(...)" .- R_H
      M_O -- "postDispatch(...)\n{fee}" --> R_H
      M_O -- "postDispatch(...)\n{value - fee}" --> D_H
    end
```

### Required Hook

è¦æŸ¥è¯¢æ‰€éœ€çš„é’©å­é…ç½®ï¼Œå¯ä»¥è°ƒç”¨`requiredHook`å‡½æ•°ã€‚

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/interfaces/IMailbox.sol#L55

```

</TabItem>
</Tabs>

### Default Hook

è¦æŸ¥è¯¢é»˜è®¤çš„é’©å­é…ç½®ï¼Œå¯ä»¥è°ƒç”¨ `defaultHook` å‡½æ•°ã€‚

<Tabs groupId="lang">
<TabItem value="sol" label="Solidity">

```solidity file=<rootDir>/node_modules/@hyperlane-xyz/core/contracts/interfaces/IMailbox.sol#L53

```

</TabItem>
</Tabs>

è¦åœ¨`dispatch` è°ƒç”¨ä¸­ä½¿ç”¨è‡ªå®šä¹‰é’©å­è¦†ç›–é»˜è®¤é’©å­ï¼Œè¯·å‚è§[Hooks Reference](../hooks/overview.mdx)ã€‚
